test="""cid=547 pid=0 channel_order=0 channel_name=[*cspacer01]_ total_clients=0 channel_needed_subscribe_power=0|cid=555 pid=0 channel_order=547 channel_name=[cspacer0]~\sRules\s~ total_clients=0 channel_needed_subscribe_power=0|cid=1493 pid=0 channel_order=555 channel_name=[*cspacer2]_ total_clients=0 channel_needed_subscribe_power=0|cid=557 pid=0 channel_order=1493 channel_name=[cspacer0]~\sducsuus.com\/rules\s~ total_clients=0 channel_needed_subscribe_power=0|cid=8 pid=0 channel_order=557 channel_name=[*cspacer0] total_clients=0 channel_needed_subscribe_power=0|cid=594 pid=8 channel_order=0 channel_name=The\sAdmin\sChannel\s(Admin\sAffairs\sHere) total_clients=0 channel_needed_subscribe_power=0|cid=826 pid=0 channel_order=8 channel_name=[*cspacer044]_ total_clients=0 channel_needed_subscribe_power=0|cid=2 pid=0 channel_order=826 channel_name=[cspacer0]~\sLobbies\s~ total_clients=0 channel_needed_subscribe_power=0|cid=563 pid=0 channel_order=2 channel_name=[*cspacer04]_ total_clients=0 channel_needed_subscribe_power=0|cid=1 pid=0 channel_order=563 channel_name=Lobby total_clients=2 channel_needed_subscribe_power=0|cid=115 pid=0 channel_order=1 channel_name=Talking\s1 total_clients=3 channel_needed_subscribe_power=0|cid=116 pid=0 channel_order=115 channel_name=Talking\s2 total_clients=0 channel_needed_subscribe_power=0|cid=558 pid=0 channel_order=116 channel_name=[*cspacer05]_ total_clients=0 channel_needed_subscribe_power=0|cid=336 pid=0 channel_order=558 channel_name=[cspacer0]~\sAFK\s(double\sclick\sme)\s~ total_clients=1 channel_needed_subscribe_power=0|cid=567 pid=0 channel_order=336 channel_name=[*cspacer07]_ total_clients=0 channel_needed_subscribe_power=0|cid=7 pid=0 channel_order=567 channel_name=[cspacer0]~\sUser\sCreated\sChatrooms\s~ total_clients=0 channel_needed_subscribe_power=0|cid=571 pid=0 channel_order=7 channel_name=[*cspacer08]_ total_clients=0 channel_needed_subscribe_power=0|cid=1727 pid=0 channel_order=571 channel_name=Begin\sBeta\sRata\sTester;\sRead\sDescription total_clients=0 channel_needed_subscribe_power=0|cid=1744 pid=0 channel_order=1727 channel_name=[b]\sXeffx's\swhite\svan\sfilled\swith\scandy. total_clients=0 channel_needed_subscribe_power=0|cid=138 pid=0 channel_order=1744 channel_name=[b]\sJoey's\sRelaxing\sRoom total_clients=1 channel_needed_subscribe_power=0|cid=206 pid=138 channel_order=0 channel_name=Jake's\sMultiverse\sServer total_clients=0 channel_needed_subscribe_power=0|cid=340 pid=138 channel_order=206 channel_name=Joey's\sprivate\sgameroom total_clients=-1 channel_needed_subscribe_power=9999|cid=341 pid=138 channel_order=340 channel_name=Joey's\safk\sroom total_clients=0 channel_needed_subscribe_power=0|cid=1176 pid=138 channel_order=341 channel_name=The\sBikini\sBandits total_clients=0 channel_needed_subscribe_power=0|cid=1401 pid=0 channel_order=138 channel_name=[b]\sThe\sBoogaloo\sCrew total_clients=0 channel_needed_subscribe_power=0|cid=1751 pid=1401 channel_order=0 channel_name=funny\smeme\sroom total_clients=0 channel_needed_subscribe_power=0|cid=1732 pid=0 channel_order=1401 channel_name=[b]\sCompawompadoodah\sV6\s\p\sThe\sVault total_clients=0 channel_needed_subscribe_power=0|cid=1750 pid=1732 channel_order=0 channel_name=Itty\sBitty\sTitty\sCommittee total_clients=1 channel_needed_subscribe_power=0|cid=34 pid=0 channel_order=1732 channel_name=[b]\sJegs'\sChat total_clients=0 channel_needed_subscribe_power=0|cid=35 pid=34 channel_order=0 channel_name=Waiting\sRoom\s-\sJOIN\sHERE\s&\sPOKE total_clients=0 channel_needed_subscribe_power=0|cid=1374 pid=34 channel_order=35 channel_name=Downloads\sFolder total_clients=0 channel_needed_subscribe_power=0|cid=1736 pid=0 channel_order=34 channel_name=[b]\sSteamy\sLove\sShack total_clients=0 channel_needed_subscribe_power=0|cid=1754 pid=1736 channel_order=0 channel_name=Derpa total_clients=0 channel_needed_subscribe_power=0|cid=353 pid=0 channel_order=1736 channel_name=[b]\sToucan\sHill\sZone total_clients=0 channel_needed_subscribe_power=0|cid=1755 pid=353 channel_order=0 channel_name=wac total_clients=0 channel_needed_subscribe_power=0|cid=32 pid=0 channel_order=353 channel_name=[cspacer0]- total_clients=0 channel_needed_subscribe_power=0|cid=1486 pid=0 channel_order=32 channel_name=LETHALBIZZLE\sBARRYDUCKLE total_clients=0 channel_needed_subscribe_power=0|cid=966 pid=0 channel_order=1486 channel_name=Steamy\sLove\sShed total_clients=2 channel_needed_subscribe_power=0|cid=1177 pid=0 channel_order=966 channel_name=HOW\sTO\sBE\sCRAP\sAT\sA\sHEIST total_clients=0 channel_needed_subscribe_power=0|cid=861 pid=0 channel_order=1177 channel_name=Seb's\sDungeon total_clients=0 channel_needed_subscribe_power=0|cid=1360 pid=861 channel_order=0 channel_name=I\sHate\sHarry\sClub\s<3 total_clients=0 channel_needed_subscribe_power=0|cid=901 pid=861 channel_order=1360 channel_name=Seb's\sVery\sSpecial\sSecret\sDungeon total_clients=-1 channel_needed_subscribe_power=34463|cid=765 pid=0 channel_order=861 channel_name=vS\sClan total_clients=0 channel_needed_subscribe_power=0|cid=169 pid=765 channel_order=0 channel_name=vS\steam\s1 total_clients=0 channel_needed_subscribe_power=0|cid=651 pid=0 channel_order=765 channel_name=Azedea's\sCrew total_clients=0 channel_needed_subscribe_power=0|cid=11 pid=0 channel_order=651 channel_name=Cpone's\sPrivate\sChat total_clients=0 channel_needed_subscribe_power=0|cid=887 pid=0 channel_order=11 channel_name=Joe\sand\sJonny's\sMovie\sTheater total_clients=0 channel_needed_subscribe_power=0|cid=1314 pid=0 channel_order=887 channel_name=Skype\sNerds\sDown\sHere total_clients=0 channel_needed_subscribe_power=0|cid=1630 pid=0 channel_order=1314 channel_name=The\sLate\sNight\sJazz\sChannel total_clients=0 channel_needed_subscribe_power=0|cid=1715 pid=0 channel_order=1630 channel_name=The\sCommonwealth\sof\sRob total_clients=0 channel_needed_subscribe_power=0|cid=1740 pid=0 channel_order=1715 channel_name=Matti's\sMagic\sDungeon total_clients=0 channel_needed_subscribe_power=0
"""


# Misc functions that will be supplied in other files
def get_value(string):

    key_name = ""
    key_value = ""
    found_seperator = False
    for character in string:
        if not found_seperator:
            if character == "=":
                found_seperator = True
            else:
                key_name += character
        else:
            key_value += character
    return(key_name, key_value)

def get_channel_info():

    try:

        t = telnetlib.Telnet(host, port)

        t.write(("login serveradmin " + password + "\n").encode())
        t.write(("use 1\n").encode())

        time.sleep(1)

        t.read_very_eager()

        t.write(("channellist" + "\n").encode())

        time.sleep(1)

        channellist_response = t.read_very_eager().decode()

        t.write(("quit\n").encode())

        return channellist_response

    except Exception as e:

        print("An error occured;" + str(e))

        return False
# Overide just to make things easier for testing, use prior line's function instead in real thing
def get_channel_info():
    return test

# Function which need to be implemented into main program

# Main part of the program

channel_scores = {}

def update_channel_scores():

    # Count all of the subchannels, and the number of clients in those channels, based on a channel (and its channel id)
    # Needs access to the channel_list variable, specific to this function
    def count_channel(target_channel_id):

        print("target_channel_id: " + str(target_channel_id))

        channel_client_count = channel_list[target_channel_id][2]
        channel_subchannel_count = 0

        for channel_id in channel_list:

            print(channel_id)

            if channel_list[channel_id][1] == target_channel_id:

                # Python does not allow multiple values to be added to multiple variables returned from a function,
                # so they have to be assigned to a new variable first, then added onto the "target" variables.
                new_channel_client_count, new_channel_subchannel_count = count_channel(channel_id)

                channel_client_count += new_channel_subchannel_count
                channel_subchannel_count += new_channel_subchannel_count
        
        return channel_client_count, channel_subchannel_count

    # The response of the query from the server
    channellist_response = get_channel_info()

    #channel_list[channel_id] = [channel_name, channel_pid, channel_clients]
    channel_list = {}

    for channel in channellist_response.split("|"):

        channel_tags = channel.split(" ")

        channel_name = ""
        channel_id = -1
        channel_pid = -1
        channel_clients = -1

        for tag in channel_tags:

            key_name, key_value = get_value(tag)

            if key_name == "channel_name":

                channel_name = key_value

            elif key_name == "cid":

                channel_id = int(key_value)

            elif key_name == "total_clients":

                channel_clients = int(key_value)

            elif key_name == "pid":

                channel_pid = int(key_value)

        if channel_name != "" and channel_id >= 0 and channel_pid >= 0 and channel_clients >= 0:

            channel_list[channel_id] = [channel_name, channel_pid, channel_clients]

    for channel_id in channel_list:

        # If it's a top level channel       and       a beta-participating channel (temp)
        if channel_list[channel_id][1] == 0 and channel_list[channel_id][0][0:3] == "[b]":

            channel_client_count, channel_subchannel_count = count_channel(channel_id)

            #print("channel_client_count: " + str(channel_client_count) + " channel_subchannel_count: " + str(channel_subchannel_count))

            # Get the score; the average client per chanel (hence the add one to the subchannel count, so that the parent channel is included)
            channel_score = channel_client_count / (channel_subchannel_count + 1)

            if channel_id in channel_scores:

                channel_scores[channel_id].append(channel_score)

                while len(channel_scores[channel_id]) > 10:

                    channel_scores[channel_id].pop(0)

            else:

                channel_scores[channel_id] = [0.0] * 9 + [channel_score]

update_channel_scores()

print(str(channel_scores))










